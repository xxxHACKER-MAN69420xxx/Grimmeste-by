<!DOCTYPE html>
<html lang="da">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Danmarks Grimmeste by</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
	<style>
		:root { 
			--main: #e6192e; 
			--bg: #fdfdfd; 
		}

		body { 
			/* 1. THE IMAGE SETTINGS */
			background-image: url('https://smooth-storage.aptoma.no/users/mhmdk/images/144683288.webp?t%5Bstrip%5D=true&t%5Bcrop%5D%5Bx%5D=0&t%5Bcrop%5D%5By%5D=0&t%5Bcrop%5D%5Bwidth%5D=5472&t%5Bcrop%5D%5Bheight%5D=3648&t%5Bquality%5D=80&t%5Bresize%5D%5Bwidth%5D=930&t%5Bresize%5D%5Bheight%5D=620&accessToken=ae71e9076c8f9ab0e93285070fb12f58fbf14d99e9c4413e37f8962fd732e0ec');
			background-size: cover;
			background-repeat: no-repeat;
			background-position: center center;
			background-attachment: fixed;

			/* 2. THE REST OF YOUR BODY STYLES */
			font-family: 'Inter', sans-serif; 
			color: #333; 
			display: flex; 
			flex-direction: column; 
			align-items: center; 
			padding: 20px; 
			margin: 0; /* Added to remove white borders */
			min-height: 100vh; /* Ensures background covers full height */
		}

		/* Rest of your CSS remains the same */
		.card { background: white; border-radius: 16px; box-shadow: 0 10px 40px rgba(0,0,0,0.08); width: 100%; max-width: 450px; padding: 2rem; border-top: 6px solid var(--main); }
		.leader { background: #fff5f5; border: 1px solid #ffccd0; padding: 15px; border-radius: 10px; margin-bottom: 25px; text-align: center; }
		.leader h3 { margin: 0; font-size: 0.9rem; text-transform: uppercase; color: var(--main); }
		.leader-name { font-size: 1.8rem; font-weight: 800; display: block; }
		input, select { width: 100%; padding: 12px; margin: 10px 0; border: 2px solid #ddd; border-radius: 8px; font-size: 1rem; box-sizing: border-box; }
		.vote-btn { width: 100%; padding: 15px; background: var(--main); color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; transition: 0.2s; font-size: 1.1rem; }
		.vote-btn:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(230,25,46,0.3); }
		.result-bar { height: 8px; background: #eee; border-radius: 10px; margin-top: 5px; overflow: hidden; }
		.fill { height: 100%; background: var(--main); width: 0%; transition: 1s ease-out; }
	</style>
</head>
<body>

    <div class="card">
        <div class="leader">
            <h3>Nuv√¶rende Grimmeste byüèÜ</h3>
            <span id="top-city" class="leader-name">Indl√¶ser...</span>
        </div>

        <h2>Danmarks Grimmeste by?</h2>
        
        <label for="city-choice">V√¶lg din by:</label>
        <input list="cities" id="city-choice" name="city-choice" placeholder="S√∏g efter by...">
        <datalist id="cities">
            </datalist>

        <button class="vote-btn" onclick="castVote()">STEM NU</button>

        <div id="results-list" style="margin-top: 30px; font-size: 0.9rem;">
            </div>
    </div>

<script>
    const SUPABASE_URL = 'https://wnbqukzvbeszcuvzjqwi.supabase.co';
    const SUPABASE_KEY = 'sb_publishable_QUuLyzmY0RwmCwAO8MhmTA_Lseoj2Uk';
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // UNIQUE KEY FOR YOUR POLL
    const STORAGE_KEY = 'danmark_by_poll_voted';

    async function updateDisplay() {
    // 1. Fetch ALL towns (alphabetically) for the Search Dropdown
    const { data: allTowns } = await supabaseClient
        .from('votes')
        .select('option_name')
        .order('option_name', { ascending: true });

    // 2. Fetch TOP 20 towns for the Results Leaderboard
    const { data: topTowns } = await supabaseClient
        .from('votes')
        .select('*')
        .order('vote_count', { ascending: false })
        .limit(20);

    // 3. Calculate Total Votes (based on everything)
    const { data: totalData } = await supabaseClient.from('votes').select('vote_count');
    const total = totalData.reduce((acc, t) => acc + t.vote_count, 0);
    
    // Update Leader Name (The #1 spot)
    document.getElementById('top-city').innerText = topTowns[0] ? topTowns[0].option_name : "Ingen stemmer";

    // Update the Search Dropdown (Show EVERY town)
    const datalist = document.getElementById('cities');
    datalist.innerHTML = ''; // Clear it out
    allTowns.forEach(t => {
        const opt = document.createElement('option');
        opt.value = t.option_name;
        datalist.appendChild(opt);
    });

    // Update the Visual Results (Show ONLY top 20)
    const results = document.getElementById('results-list');
    results.innerHTML = "<strong>Top 20 Byer:</strong>";
    
    topTowns.forEach(t => {
        const pct = total > 0 ? ((t.vote_count / total) * 100).toFixed(1) : 0;
        results.innerHTML += `
            <div style="margin: 10px 0;">
                <div style="display:flex; justify-content:space-between;">
                    <span>${t.option_name}</span>
                    <span>${pct}% (${t.vote_count})</span>
                </div>
                <div class="result-bar"><div class="fill" style="width:${pct}%"></div></div>
            </div>`;
    });

        // CHECK IF USER HAS ALREADY VOTED
        checkVoterStatus();
    }

    function checkVoterStatus() {
        if (localStorage.getItem(STORAGE_KEY)) {
            const btn = document.querySelector('.vote-btn');
            btn.disabled = true;
            btn.innerText = "DU HAR STEMT ‚úì";
            btn.style.background = "#ccc";
            btn.style.cursor = "not-allowed";
        }
    }

    async function castVote() {
        // Double check lock before sending to database
        if (localStorage.getItem(STORAGE_KEY)) return;

        const cityName = document.getElementById('city-choice').value;
        const { data } = await supabaseClient.from('votes').select('vote_count').eq('option_name', cityName).single();
        
        if (data) {
            await supabaseClient.from('votes').update({ vote_count: data.vote_count + 1 }).eq('option_name', cityName);
            
            // SET THE LOCK
            localStorage.setItem(STORAGE_KEY, 'true');
            
            alert("Tak for din stemme!");
            updateDisplay();
        } else {
            alert("V√¶lg venligst en gyldig by fra listen.");
        }
    }

    updateDisplay();
</script>
</body>
</html>
